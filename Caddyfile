# Caddy Reverse Proxy Configuration untuk Permathadi Swara
#
# Setup Full Docker:
# - Caddy: Port 80 (HTTP) dan 443 (HTTPS) - berjalan di container
# - Laravel Sail: Port 80 (dalam container) - diakses oleh Caddy via service name
# - Vite Dev Server: Port 5173 (dalam container) - diakses oleh Caddy via service name
#
# Semua service berjalan di Docker network 'sail' dan saling akses via service names

permathadi-swara.test {
	# TLS/SSL - Caddy akan auto-generate certificate untuk local domain
	# Menggunakan 'tls internal' untuk development (tidak perlu setup manual)
	tls internal

	# Logging (optional)
	log {
		output stdout
		format console
	}

	# Vite dev server - proxy all Vite-related paths
	# Order matters: more specific paths first
	# Semua request ke path Vite akan di-proxy ke Vite dev server container

	# Proxy @vite and @ paths (Vite HMR)
	handle /@vite* {
		reverse_proxy http://vite:5173 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}

	handle /@* {
		reverse_proxy http://vite:5173 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}

	# Proxy node_modules (Vite dependencies)
	handle /node_modules* {
		reverse_proxy http://vite:5173 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}

	# Proxy resources path (Vite assets)
	handle /resources* {
		reverse_proxy http://vite:5173 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}

	# Max request body size (20MB) - applies to all requests
	# Untuk upload file yang lebih besar
	request_body {
		max_size 20MB
	}

	# Proxy to Laravel Sail container (default handler)
	# Semua request lainnya akan di-proxy ke Laravel container via service name
	handle {
		reverse_proxy http://laravel:80 {
			header_up Host {host}
			header_up X-Real-IP {remote}
			header_up X-Forwarded-Proto {scheme}
			header_up X-Forwarded-For {remote}
			transport http {
				dial_timeout 10s
				response_header_timeout 10s
			}
			# Retry logic untuk handle connection issues
			fail_duration 5s
			max_fails 3
			unhealthy_status 500 502 503 504
		}
	}
}

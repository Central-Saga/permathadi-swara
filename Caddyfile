# Caddy Reverse Proxy Configuration untuk Permathadi Swara
#
# Port Configuration:
# - Caddy: Port 80 (HTTP) dan 443 (HTTPS) - untuk reverse proxy
# - Laravel Sail: Port 8080 (APP_PORT di .env) - diakses oleh Caddy
# - Vite Dev Server: Port 5173 - diakses oleh Caddy untuk dev assets
#
# Pastikan APP_PORT=8080 di file .env agar tidak konflik dengan Caddy

permathadi-swara.test {
	# TLS/SSL - Caddy akan auto-generate certificate untuk local domain
	# Menggunakan 'tls internal' untuk development (tidak perlu setup manual)
	tls internal

	# Logging (optional)
	log {
		output stdout
		format console
	}

	# Vite dev server - proxy all Vite-related paths
	# Order matters: more specific paths first
	# Semua request ke path Vite akan di-proxy ke Vite dev server (port 5173)

	# Proxy @vite and @ paths (Vite HMR)
	handle /@vite* {
		reverse_proxy http://127.0.0.1:5173 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}

	handle /@* {
		reverse_proxy http://127.0.0.1:5173 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}

	# Proxy node_modules (Vite dependencies)
	handle /node_modules* {
		reverse_proxy http://127.0.0.1:5173 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}

	# Proxy resources path (Vite assets)
	handle /resources* {
		reverse_proxy http://127.0.0.1:5173 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}

	# Max request body size (20MB) - applies to all requests
	# Untuk upload file yang lebih besar
	request_body {
		max_size 20MB
	}

	# Proxy to Laravel Sail container (default handler)
	# Semua request lainnya akan di-proxy ke Laravel (port 8080)
	# Pastikan APP_PORT=8080 di .env
	handle {
		reverse_proxy http://127.0.0.1:8080 {
			header_up Host {host}
			header_up X-Real-IP {remote}
		}
	}
}
